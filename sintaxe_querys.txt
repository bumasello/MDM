-- q_recupDataPacCursorDtl --------------------------------------------------------------------------------------
Faz uma chamada ao banco acionando as procedures que populam as STG de cada HIS.

CHAMADA:
BEGIN
recupDataPacCursorBanguDtl();
recupDataPacCursorCaxiasDtl();
recupDataPacCursorNiteroiDtl();
recupDataPacCursorGloriaDtl();
END;

Sintaxe query: 
CREATE OR REPLACE NONEDITIONABLE PROCEDURE recupDataPacCursorBanguDtl AS
  CURSOR cur_dados IS
    SELECT CD_PRONTUARIO, NM_PACIENTE, NM_MAE, NM_PAI, DT_NASCIMENTO, CD_SEXO, NR_CPF,
           nm_lgr_end_residencial, nr_end_residencial, nm_brro_end_residencial,
           nm_cid_end_residencial, cep_end_residencial, nr_tel_residencial,
           nr_tel_celular, nr_tel_comercial, dt_abrt_prontuario, ds_email,
           bip, dt_pcm_cdd, flag_prc_para_bip
    FROM hospital_bangu@hospital_bangu_dtl;

  -- Declaração de variáveis para armazenar os valores do cursor
  variavel1 stg_paciente_bangu.CD_PRONTUARIO%TYPE;
  variavel2 stg_paciente_bangu.NM_PACIENTE%TYPE;
  variavel3 stg_paciente_bangu.NM_MAE%TYPE;
  variavel4 stg_paciente_bangu.NM_PAI%TYPE;
  variavel5 stg_paciente_bangu.DT_NASCIMENTO%TYPE;
  variavel6 stg_paciente_bangu.CD_SEXO%TYPE;
  variavel7 stg_paciente_bangu.NR_CPF%TYPE;
  variavel8 stg_paciente_bangu.nm_lgr_end_residencial%TYPE;
  variavel9 stg_paciente_bangu.nr_end_residencial%TYPE;
  variavel10 stg_paciente_bangu.nm_brro_end_residencial%TYPE;
  variavel11 stg_paciente_bangu.nm_cid_end_residencial%TYPE;
  variavel12 stg_paciente_bangu.cep_end_residencial%TYPE;
  variavel13 stg_paciente_bangu.nr_tel_residencial%TYPE;
  variavel14 stg_paciente_bangu.nr_tel_celular%TYPE;
  variavel15 stg_paciente_bangu.nr_tel_comercial%TYPE;
  variavel16 stg_paciente_bangu.dt_abrt_prontuario%TYPE;
  variavel17 stg_paciente_bangu.ds_email%TYPE;
  variavel18 stg_paciente_bangu.bip%TYPE;
  variavel19 stg_paciente_bangu.dt_pcm_cdd%TYPE;
  variavel20 stg_paciente_bangu.flag_prc_para_bip%TYPE;
BEGIN
  -- Abrir o cursor
  OPEN cur_dados;

  -- Loop para percorrer os dados do cursor
  LOOP
    FETCH cur_dados INTO 
    variavel1, 
    variavel2, 
    variavel3, 
    variavel4, 
    variavel5, 
    variavel6, 
    variavel7,
    variavel8, 
    variavel9, 
    variavel10, 
    variavel11, 
    variavel12, 
    variavel13, 
    variavel14,
    variavel15,
    variavel16,
    variavel17,
    variavel18,
    variavel19,
    variavel20;
    EXIT WHEN cur_dados%NOTFOUND;

    -- Inserir os dados na tabela stg_paciente_bangu
    INSERT INTO stg_paciente_bangu (
    CD_PRONTUARIO, 
    NM_PACIENTE, 
    NM_MAE, 
    NM_PAI, 
    DT_NASCIMENTO, 
    CD_SEXO, 
    NR_CPF, 
    nm_lgr_end_residencial, 
    nr_end_residencial, 
    nm_brro_end_residencial,
    nm_cid_end_residencial,
    cep_end_residencial,
    nr_tel_residencial,
    nr_tel_celular,
    nr_tel_comercial,
    dt_abrt_prontuario,
    ds_email,
    bip,
    dt_pcm_cdd,
    flag_prc_para_bip)
    VALUES (
    variavel1, 
    variavel2, 
    variavel3, 
    variavel4, 
    variavel5, 
    variavel6, 
    variavel7,
    variavel8,
    variavel9,
    variavel10,
    variavel11, 
    variavel12, 
    variavel13, 
    variavel14, 
    variavel15, 
    variavel16, 
    variavel17,
    variavel18,
    variavel19,
    variavel20);
  END LOOP;

  -- Fechar o cursor
  CLOSE cur_dados;

  COMMIT; -- Comitar as mudanças para o banco
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
END;

-- q_log_controle_inicio -----------------------------------------------------------------------------------
Fica responsável por logar o inicio das querys nos bancos de controle do MDM.

CHAMADA: 
BEGIN
log_controle_mdm_inicio('recupDataPac');
END;

Sintaxe query:
CREATE OR REPLACE PROCEDURE LOG_CONTROLE_MDM_INICIO(
  p_nm_carga IN VARCHAR2
) AS
BEGIN
  INSERT INTO controle_mdm_inicio (id_carga, dt_inicio, nm_carga)
  VALUES (seq_id_carga.NEXTVAL, SYSDATE, p_nm_carga);
  COMMIT;
END;
/

-- q_log_controle_fim -----------------------------------------------------------------------------------
Fica responsável por logar o fim das querys nos bancos de controle do MDM.

CHAMADA:
BEGIN
log_controle_mdm_fim('recupDataPac');
END;

Sintaxe query:
CREATE OR REPLACE PROCEDURE LOG_CONTROLE_MDM_FIM(
  p_nm_carga IN VARCHAR2
) AS
  v_id_carga_inicio controle_mdm_inicio.id_carga%TYPE;
BEGIN
  SELECT MAX(id_carga) INTO v_id_carga_inicio
  FROM controle_mdm_inicio
  WHERE nm_carga = p_nm_carga;

  INSERT INTO controle_mdm_fim (id_carga, dt_fim, nm_carga, id_carga_inicio)
  VALUES (seq_id_carga.NEXTVAL, SYSDATE, p_nm_carga, v_id_carga_inicio);
  COMMIT;
END;
/